/*
 * Contains the current implementation of `InstanceOptions`.
 *
 * Copyright (c) 2018 Joseph R Cowman
 * Licensed under MIT License (see https://github.com/regal/regal)
 */

import { RegalError } from "../../error";
import { generateSeed } from "../../random";
import { GameInstance, GameInstanceInternal } from "../../state";
import { DEFAULT_GAME_OPTIONS, GameOptions } from "../game-options";
import { InstanceOptionsInternal } from "../instance-options-internal";
import { MetadataManager } from "../metadata-manager";
import { ensureOverridesAllowed, validateOptions } from "./validate-options";

/** Prevents `InstanceOptions.overrides` from being modified. */
const OPTION_OVERRIDES_PROXY_HANDLER = {
    set() {
        throw new RegalError(
            "Cannot modify the properties of the InstanceOption option overrides."
        );
    }
};

/** Prevents `InstanceOptions` from being modified. */
const INSTANCE_OPTIONS_PROXY_HANDLER = {
    get(
        target: InstanceOptionsInternal,
        propertyKey: PropertyKey,
        receiver: object
    ) {
        // If the option hasn't been overridden, get the default value.
        return target[propertyKey] === undefined
            ? DEFAULT_GAME_OPTIONS[propertyKey]
            : Reflect.get(target, propertyKey, receiver);
    },

    set() {
        throw new RegalError(
            "Cannot modify the properties of InstanceOptions."
        );
    }
};

/**
 * Builds a new `InstanceOptions` based on the options specified
 * in the static configuration, allowing for option overrides (if valid).
 *
 * @param game The game instance that owns this `InstanceOptions`.
 * @param overrides Any option overrides preferred for this specific instance.
 * Must be allowed by the static configuration's `allowOverrides` option.
 * @param generatedSeed Include if the previous GameInstance had a default-generated seed
 */
export const buildInstanceOptions = (
    game: GameInstanceInternal,
    overrides: Partial<GameOptions>,
    generatedSeed?: string
): InstanceOptionsInternal =>
    new InstanceOptionsImpl(game, overrides, generatedSeed);

class InstanceOptionsImpl implements InstanceOptionsInternal {
    public allowOverrides: string[] | boolean;
    public debug: boolean;
    public showMinor: boolean;
    public trackAgentChanges: boolean;
    public seed: string;

    public readonly overrides: Partial<GameOptions>;

    constructor(
        public game: GameInstanceInternal,
        overrides: Partial<GameOptions>,
        generatedSeed?: string
    ) {
        validateOptions(overrides);

        const configOpts = MetadataManager.getMetadata().options;
        validateOptions(configOpts);

        const allowOverrides =
            configOpts.allowOverrides !== undefined
                ? configOpts.allowOverrides
                : DEFAULT_GAME_OPTIONS.allowOverrides;

        ensureOverridesAllowed(overrides, allowOverrides);

        const overrideKeys = Object.keys(overrides);
        const configKeys = Object.keys(configOpts);

        configKeys
            .filter(key => !overrideKeys.includes(key))
            .forEach(key => (this[key] = configOpts[key]));

        overrideKeys.forEach(key => (this[key] = overrides[key]));

        // If passed a specified seed (as in generated by a previous GameInstance), use it.
        // Otherwise, generate a new one.
        if (this.seed === undefined) {
            this.seed =
                generatedSeed !== undefined ? generatedSeed : generateSeed();
        }

        this.overrides = new Proxy(overrides, OPTION_OVERRIDES_PROXY_HANDLER);
        return new Proxy(this, INSTANCE_OPTIONS_PROXY_HANDLER);
    }
}
